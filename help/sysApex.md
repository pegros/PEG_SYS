# ![Logo](/media/logo.png) &nbsp; Main **Apex** Package

## Introduction

The **PEG_SYS** package primarily relies on a set of Custom objects and
Schedulable Apex classes to fetch and store various technical snapshot 
data which may be used directly on the Salesforce core platform.

As a baseline, a standard **SYS Monitoring** Application is provided
which provides access to the various custom objects included in the 
**PEG_SYS** package.

![SYS Monitoring App](/media/MonitoringApp.png)

By default, only object tabs and some list views are provided.
This initial configuration may easily be extended by setting other
custom list views or building standard reports and dashboards.


## Available Snapshots

Notes:
* All custom objects have names prefixed as `SYS_`
* The creation date of these records correspond to the snapshot timestamp.


### **Org Licenses**

This object contains snapshots fetched by SOQL queries on the standard **UserLicense**
and **PermissionSetLicense** objects. Record Types segregate the two data source.

![Org Licenses List View](/media/OrgLicenses.png)


### **Org Limits**

This object contains snapshots fetched via the standard **Apex OrgLimit API**.

![Org Limits List View](/media/OrgLimits.png)


### **Org Storage**

This object contains snapshots fetched by parsing the standard **Storage Usage** Setup page.
Multiple Record Types are available, segregating data corresponding to each of the table
available in this page. Field values are set depending on each Record Type, as well as the
meaning of the ratio. 

![Org Storage List View](/media/OrgStorage.png)


### **Picklist Values**

This object contains snapshots fetched by leveraging standard **Apex Schema.describe()** calls.
A unique name is generated concatenating the object, the field and the value code, enabling
to easily perform augment / join operations in **CRM Analytics** dataflows / recipes to set 
labels corresponding to picklist fields in datasets.

![Picklist List View](/media/Picklist.png)


### **(System) Permissions**

This object contains for Profiles, Permission Set Groups and Permission Sets the list of
active System Permissions (via `permission...` fields) in order to leverage them more easiy
in Reports and Dashboards or load them as records in a **CRM Analytics** dataset.

![Picklist List View](/media/Permission.png)


### **Objects**

This object contains the list of all SObjects defined on the platform.

![Object List View](/media/Objects.png)


## Package Configuration

### Access to Snapshot Objects

You need to grant the **SYS_UseScheduleTools** permission set to all users requiring
access to the **SYS Monitoring** App or the **SYS** custom objects (especially the user
scheduling the snapshot Apex classes and the **CRM Analytics** integration user if you 
want to synch data there).


### Snapshots Configuration

Snapshots are generated by Apex schedulable classes on a per custom object basis.
* **SYS_OrgLicenseSnapshot_SCH** generates **SYS_OrgLicenseSnapshot** records
* **SYS_OrgLimitSnapshot_SCH** generates **SYS_OrgLimitSnapshot** records
* **SYS_OrgStorageSnapshot_SCH** generates **SYS_OrgStorageSnapshot** records
* **SYS_PicklistSnapshot_SCH** generates **SYS_PicklistSnapshot** records
* **SYS_PermissionSnapshot_SCH** generates **SYS_PermissionSnapshot** records
* **SYS_ObjectSnapshot_SCH** generates **SYS_ObjectSnapshot** records

Each process relies on its dedicated _custom setting_ or _custom metadata_ records
to customise its behaviour:
* **Custom Setting** records
    * They are available for the generation of most Snapshot Object records (with `Config` naming suffix)
    * They basically enable to set a data retention period (in days), everything being kept by default if not set
    * For **SYS_OrgLimitConfig**, it also enables to bypass some uninteresting limits (as a comma separated list of limit names).
* **Custom Metadata** records
    * They are available for the _Picklist_ snapshot to define the set of picklist fields to consider
    * By default, the `MasterLabel` of `SYS_PicklistLabel` metadata records should be in the `ObjectApiName.FieldApiName` format to indicate which picklist to process.
    * As there is a label size limitation, it is possible to set this value in the `Picklist` field instead (in which case this information supersedes that in the `MasterLabel`)


### Snapshot Scheduling / Unscheduling

Each snapshot process has its own Apex Schedulable Apex class as trigger and may therefore be scheduled 
independentely. Some however rely on queueable Apex asynchronous subprocesses for completion
(e.g. **SYS_OrgStorageSnapshot_SCH**).

Hereafter is a standard Apex command enabling you to schedule all your jobs, e.g. from the
_anonymous execution window_ of the _dev console_.
```
String hourlySchedule = '0 0 * * * ?'; 
String dailySchedule = '0 0 1 * * ?'; 
String weeklySchedule = '0 0 1 ? * 1'; 

SYS_OrgLicenseSnapshot_SCH job1 = new SYS_OrgLicenseSnapshot_SCH(); 
system.schedule('Weekly Org License Snaphots', weeklySchedule, job1);

SYS_OrgLimitSnapshot_SCH job2 = new SYS_OrgLimitSnapshot_SCH(); 
system.schedule('Hourly Org Limits Snaphots', hourlySchedule, job2);

SYS_OrgStorageSnapshot_SCH job3 = new SYS_OrgStorageSnapshot_SCH(); 
system.schedule('Weekly Org Storage Snaphots', weeklySchedule, job3);

SYS_PicklistSnapshot_SCH job4 = new SYS_PicklistSnapshot_SCH(); 
system.schedule('Daily Picklist Snaphots', dailySchedule, job4);

SYS_PermissionSnapshot_SCH job5 = new SYS_PermissionSnapshot_SCH(); 
system.schedule('Daily Permission Snaphots', dailySchedule, job5);

SYS_ObjectSnapshot_SCH job6 = new SYS_ObjectSnapshot_SCH(); 
system.schedule('Daily Object Snaphots', dailySchedule, job6);
```

In order to easily unschedule all scheduled Apex class jobs of the **PEG_SYS** package,
e.g. when deploying a new version of the package, the following Apex command may be used.
```
List<AsyncApexJob> scheduledJobs = [SELECT  ApexClass.Name, CronTriggerId,
                                            CronTrigger.CronExpression 
                                    FROM AsyncApexJob 
                                    WHERE  JobType='ScheduledApex'
                                        AND CronTrigger.CronExpression != null
                                        AND ApexClass.Name LIKE 'SYS_%'];
if (scheduledJobs != null && scheduledJobs.size()>0) {
    for (AsyncApexJob iter : scheduledJobs) {
        System.abortJob(iter.CronTriggerId);
    }
}
```

### Snapshot Manual Launch

If necessary, snapshot processes may be manually launched via a simple Apex command,
e.g. from the _anonymous execution window_ of the _dev console_.
```
SYS_OrgLicenseSnapshot_SCH.execute(null);
SYS_OrgLimitSnapshot_SCH.execute(null);
SYS_OrgStorageSnapshot_SCH.execute(null);
SYS_PicklistSnapshot_SCH.execute(null);
SYS_PermissionSnapshot_SCH.execute(null);
SYS_ObjectSnapshot_SCH.execute(null);
```

This may be used to check that everything is OK (especially configuration and access rights)
just after installation/upgrade of the **PEG_SYS** package.


## Package Content

The Main **Apex** Package is stored in the `default` folder of the **PEG_SYS** repository.
It contains the following metadata
* 1 Application (**SYS Monitoring**)
* Schedulable Apex classes (+ related test classes), queueable Apex classes (when any) being subclasses. 
* Custom Objects (+ related tabs & layouts)
* Custom Settings & Custom Metadata
* PermissionSet (+ 1 related layout)
* 1 Static Resource (used for test class logic)
* 1 Content Asset (with the **SYS_Logo** App logo)